{% extends 'template.html.twig' %}

{% block title %}Crear Facturas{% endblock %}

 {% block addcss %}
  <style type="text/css">
    .precio,.total,.descuento{
      color:red !important;
    }
  </style>
{% endblock %}
{% block header %}
 <header id="topbar" class="ph10">

             <div class="topbar-left">
            <ol class="breadcrumb">
              <li class="crumb-active"><a href="{{ path('facturas_index') }}">Facturas</a></li>                            
              <li class="crumb-trail">Nueva Factura</li>
            </ol>
          </div>
          
        </header>
         <header id="topbar" class="ph10">
          <div class="topbar-left">
            <ul class="nav nav-list nav-list-topbar pull-left">
              <li class="active"><a href="{{ path('facturas_index') }}">Historico Factura</a></li>
              
            </ul>
          </div>
         
        </header>
<div class="content-header">
                <h2><b class="text-primary">Facturación</b>
                </h2>
              
              </div>


{% endblock %}

{% block body %}
    

    {{ include('facturas/_form.html.twig') }}


{% endblock %}


{% block addscript %}





<script type="text/javascript">
      jQuery(document).ready(function (){

$('#facturas_dias').removeAttr('required');
       $("#facturas_dias").hide();

$( "#facturas_forma input:radio" ).click(function() {
    if($(this).val() == "CR"){
       $("#facturas_dias").show();
    }else{
      $ ("#facturas_dias"). prop ('selectedIndex', 0);
       $("#facturas_dias").hide();
    }
   });
      $( ".ingresar" ).click(function() {
          var t = $('.footable').DataTable();

            var productos =  $(".producto").val();
            var cantidad =  $(".cantidad").val();
            var precio = $(".precio").val();
            var total = $(".total").val();
            var promocion = $(".promocion").val();
            var comentarios = $(".comentarios").val();
            var porcentaje = $(".descuento").val();

                   t.row.add( [
                    $(".producto option:selected").text()+"<input type='hidden' value='"+productos+"' name='productos[]'>",
                    $(".cantidad").val()+"<input type='hidden' value='"+cantidad+"' name='cantidad[]'>",
                    $(".precio").val()+"<input type='hidden' value='"+precio+"' name='precio[]'>",
                    $(".descuento").val()+"<input type='hidden' value='"+porcentaje+"' name='descuento[]'>",
                    $(".total").val(),
                    $(".promocion").val()+"<input type='hidden' value='"+promocion+"' name='promocion[]'>"+" "+"<input type='hidden' value='"+total+"' name='total[]'>",
                    $(".comentarios").val()+"<input type='hidden' value='"+comentarios+"' name='comentarios[]'>",
                     "<button type='button' class='btn btn-simple btn-danger btn-icon remove' title='Cancelar pedido'><span class='fa fa-remove'></span></button>"
                  ] ).draw( false );


                   $(".cerramodal").click();
                   $(".pedidos")[0].reset();

   var table = $('.footable').DataTable();
  var datossuma =  table.column( 4 ).data().sum();
  console.log(datossuma);
    $(".totales").html("Total: "+datossuma.toFixed(2));


          });





var total = 0;
var descuento = 0;

    $("#detalles_factura_idproducto").change(function() {
       $.get( "{{ path('buscarproducto') }}", { iditems:$(this).val()}).done(function( data ) {

            if(data.length>0){ 
                  $(".precio").val(data[0]['precioventa']);         

                  total = data[0]['precioventa']*$(".cantidad").val();                
                  $(".total").val(total);
                 $(".cantidad").change();
              }
              
          });
    });

        $(".cantidad").change(function() {

            var total = $(".precio").val()*$(".cantidad").val();                
            $(".total").val(total);

       $.get( "{{ path('buscardescuento') }}", { id:$(this).val()}).done(function( data ) {

            if(data.length>0){ 
              console.log("total "+$(".total").val());

                  //$(".descuento").val(data[0]['porcentaje']);         
                 var totaldescuento = (total*data[0]['porcentaje'])/100;
                   descuento = $(".total").val()-totaldescuento;
                  $(".descuento").val(data[0]['porcentaje']);         
                  //var total = data[0]['precioventa']*$(".cantidad").val();                
                  $(".total").val(descuento);

              }else{
                 $(".total").val(total);
                $(".descuento").val(0);                         
              }
              
          });
    });


    /*$(".cantidad").change(function() {
          var total = $(".precio").val()*$(".cantidad").val();                
          $(".total").val(total);
    });*/

    var table = $('.footable').DataTable();

    $('.footable tbody').on('click', '.remove', function () {

      var r = confirm("¿Desea quitar este registro?");
      if(r == true){
            var btn = this;
            $tr = $(this).closest('tr');
            var data = table.row($tr).data();          
            table.row($(btn).parents('tr')).remove().draw(false);


      
  var datossuma =  table.column( 4).data().sum();
  console.log(datossuma);
    $(".totales").html("Total: "+datossuma.toFixed(2));

          }
      });

      });

</script>
{% endblock %}
